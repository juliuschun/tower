# Tower — Clone & Deploy Guide

Deploy your own Tower instance for your team on a single VM.

---

## Prerequisites

| Requirement | Minimum |
|---|---|
| OS | Ubuntu 22.04+ (or any Linux with systemd) |
| Node.js | v20+ |
| RAM | 2 GB+ |
| Disk | 20 GB+ |
| Domain | Optional but recommended for HTTPS |

## 1. Clone the Repository

```bash
git clone <your-tower-repo-url> ~/claude-desk
cd ~/claude-desk
```

## 2. Run Setup

```bash
bash setup.sh
```

This will:
- Check prerequisites (Node.js, Claude CLI)
- Install npm dependencies
- Generate `.env` with a random `JWT_SECRET`
- Ask for your `PUBLIC_URL` (your domain)
- Initialize the workspace directory
- Install Claude skills and memory hooks

## 3. Authenticate Claude CLI

Each VM needs a one-time Claude login:

```bash
claude login
```

This stores credentials in `~/.claude/`. Tower uses this to spawn Claude sessions for all users.

## 4. Configure `.env`

Key settings in your `.env` file:

| Variable | Description | Example |
|---|---|---|
| `JWT_SECRET` | Auth token signing key (auto-generated by setup) | `a1b2c3...` (64 hex chars) |
| `WORKSPACE_ROOT` | Root directory users can browse | `$HOME/workspace` |
| `DEFAULT_CWD` | Default working directory for Claude sessions | `$HOME/workspace` |
| `PUBLIC_URL` | Your domain (for share links) | `https://tower.yourteam.com` |
| `PERMISSION_MODE` | Default Claude permission level | `bypassPermissions` |
| `MAX_CONCURRENT_SESSIONS` | Max simultaneous Claude sessions | `10` |
| `PORT` | Server port | `32354` |
| `NO_AUTH` | Set to `true` to disable auth (dev only) | — |

## 5. Start the Server

### Development mode (with hot reload)

```bash
npm run dev
```

- Frontend: http://localhost:32354 (Vite HMR)
- Backend: port 32355 (auto-restart on changes)

### Production mode

```bash
npm run build
./start.sh start    # uses PM2
```

Check logs: `pm2 logs tower`

## 6. Create Admin Account

1. Open `http://localhost:32354` (or your domain) in a browser
2. You'll see the setup screen — create your admin account
3. **Use a strong password** (min 8 characters)

## 7. Add Team Members

As admin, click the shield icon in the header to open the Admin Panel.

**Roles:**

| Role | Claude Permissions | System Commands |
|---|---|---|
| `admin` | Unrestricted | Unrestricted |
| `operator` | Unrestricted | No destructive system commands |
| `member` | Accept edits (no bypass) | No destructive + no package management |
| `viewer` | Read-only tools | N/A |

**`allowed_path`** — restricts what files a user (and their Claude sessions) can access. For example:
- `/home/enterpriseai/workspace/project-a` — user can only see files in this directory
- Leave empty to use the default `WORKSPACE_ROOT`

## 8. Backup

### Manual backup

```bash
bash scripts/backup.sh
```

### Automated (cron)

```bash
crontab -e
# Add this line:
0 3 * * * cd ~/claude-desk && bash scripts/backup.sh
```

Backups include: database, workspace (tar), `.env`. Keeps last 7 days.

### Restore

```bash
# Stop the server
# Copy tower.db back:
cp backups/20260228_030000/tower.db data/tower.db
# Restore workspace:
tar -xzf backups/20260228_030000/workspace.tar.gz -C ~/
# Start the server
```

## 9. Expose to Internet

### Option A: Cloudflare DNS (recommended)

1. Point your domain's DNS A record to your VM's public IP
2. Enable Cloudflare Proxy (orange cloud) for DDoS protection
3. Set SSL mode to "Full" in Cloudflare dashboard

### Option B: Cloudflare Tunnel

```bash
cloudflared tunnel --url http://localhost:32354
```

No need to open ports on the VM.

### Option C: Nginx reverse proxy + Let's Encrypt

```bash
sudo apt install nginx certbot python3-certbot-nginx
# Configure nginx to proxy to localhost:32354
# Run certbot for HTTPS
```

## 10. Security Checklist

Before going live, verify:

- [ ] `JWT_SECRET` is a random value (not the default placeholder)
- [ ] Admin password is strong (not `admin123`)
- [ ] `NO_AUTH` is **not** set to `true`
- [ ] Claude CLI is authenticated (`claude auth status`)
- [ ] `WORKSPACE_ROOT` points to the intended directory
- [ ] Non-admin users have `allowed_path` set appropriately
- [ ] Server is behind HTTPS (Cloudflare, nginx, or tunnel)
- [ ] Firewall allows only port 443 (HTTPS) inbound, or your chosen port
- [ ] Backup cron is running (`crontab -l`)

## 11. Troubleshooting

### Server won't start: "JWT_SECRET is not set"
```bash
# Generate a secret and add to .env:
echo "JWT_SECRET=$(openssl rand -hex 32)" >> .env
```

### Port conflict (EADDRINUSE)
```bash
# Check what's using the port:
fuser 32354/tcp
# Kill it:
fuser -k 32354/tcp
```

### Claude sessions fail
```bash
# Check Claude CLI auth:
claude auth status
# Re-login if needed:
claude login
```

### Zombie tsx processes
```bash
# Check for duplicate backend processes:
pgrep -fa "tsx.*backend"
# Kill extras — only one should run:
pkill -f "tsx.*backend"
npm run dev
```

### Database locked
```bash
# Check for processes using the DB:
fuser data/tower.db
# Restart the server — it will release the lock
```
